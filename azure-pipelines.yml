# Azure DevOps pipeline to build React UI Docker image and publish as artifact
# Builds the image with short SHA and build number tags, then saves a .tar artifact.

name: $(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
  tags:
    include:
      - "*"

pr:
  branches:
    include:
      - main

variables:
  # Image name (no registry prefix)
  - name: imageName
    value: fideas-react-ui

  # Build configuration
  - name: dockerfilePath
    value: Dockerfile
  - name: buildContext
    value: .

  # Artifact settings
  - name: publishArtifactName
    value: docker-image
  - name: imageTarFileName
    value: fideas-react-ui-$(Build.BuildNumber).tar

pool:
  vmImage: ubuntu-latest

stages:
  - stage: Build
    displayName: Build Image and Publish Artifact
    jobs:
      - job: docker
        displayName: Docker Build and Save
        steps:
          - checkout: self
            fetchDepth: 0

          - bash: |
              set -euo pipefail
              sha="${BUILD_SOURCEVERSION:0:7}"
              echo "Short SHA: ${sha}"
              echo "##vso[task.setvariable variable=SHORT_SHA]${sha}"
            displayName: Compute short commit SHA

          - task: Docker@2
            displayName: Build image (SHA, BuildNumber tags)
            inputs:
              command: build
              repository: $(imageName)
              Dockerfile: $(dockerfilePath)
              buildContext: $(buildContext)
              tags: |
                $(SHORT_SHA)
                $(Build.BuildNumber)

          - bash: |
              set -euo pipefail
              mkdir -p "$(Build.ArtifactStagingDirectory)"
              TAR_PATH="$(Build.ArtifactStagingDirectory)/$(imageTarFileName)"
              META_PATH="$(Build.ArtifactStagingDirectory)/image-metadata.json"

              echo "> docker save $(imageName):$(SHORT_SHA) -o ${TAR_PATH}"
              docker save "$(imageName):$(SHORT_SHA)" -o "${TAR_PATH}"

              # Collect minimal metadata
              created=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              image_id=$(docker inspect --format='{{.Id}}' "$(imageName):$(SHORT_SHA)")
              printf '%s\n' '{' \
                '  "imageName": "'"$(imageName)"'",' \
                '  "tag": "'"$(SHORT_SHA)"'",' \
                '  "buildNumber": "'"$(Build.BuildNumber)"'",' \
                '  "sourceVersion": "'"$(Build.SourceVersion)"'",' \
                '  "createdUtc": "CREATED_PLACEHOLDER",' \
                '  "imageId": "IMAGE_ID_PLACEHOLDER"' \
              '}' > "${META_PATH}"
              # Replace placeholders with shell values
              sed -i "s/CREATED_PLACEHOLDER/${created}/" "${META_PATH}"
              sed -i "s/IMAGE_ID_PLACEHOLDER/${image_id}/" "${META_PATH}"
            displayName: Save image tar and metadata

          - bash: |
              set -euo pipefail
              echo "> Validating JSON: $(Build.ArtifactStagingDirectory)/image-metadata.json"
              python3 -m json.tool "$(Build.ArtifactStagingDirectory)/image-metadata.json" > /dev/null
            displayName: Validate image-metadata.json

          - task: PublishBuildArtifacts@1
            displayName: Publish image artifact
            inputs:
              PathtoPublish: $(Build.ArtifactStagingDirectory)
              ArtifactName: $(publishArtifactName)
              publishLocation: Container
